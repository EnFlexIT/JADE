<?xml version="1.0" encoding="UTF-8"?>

<project name="JADE-LEAP for MIDP" default="do-lib">
	<!-- PROPERTIES specific for MIDP -->
	<property name="src" value="${midp-root}/src"/>
	<property name="classes" value="${midp-root}/classes"/>
	<property name="lib" value="${midp-root}/lib"/>
	<property name="doc" value="${midp-root}/doc"/>
	<property name="unverified" value="${midp-root}/unverified"/>
	<property name="midp-title" value="${title} v${version} for MIDP"/>


	<!-- INIT -->
	<target name="do-init"  
	        description="Create the appropriate directories">
		<mkdir dir="${midp-root}"/>
		<mkdir dir="${src}"/>
		<mkdir dir="${classes}"/>
		<mkdir dir="${lib}"/>
		<mkdir dir="${doc}"/>
		<mkdir dir="${unverified}"/>
	</target>

	
	<!-- SETUP SMS -->
	<target name="do-setup-sms" depends="do-init" if="wma-classes"
	        description="Copy the files that require the WMA to be compiled">
	  <copy todir="${src}">
			<fileset dir="${leap-src}">
				<include name="**/jade/imtp/leap/sms/*"/>
			</fileset>
		</copy>
	</target>
	
	<!-- SETUP -->
	<target name="do-setup" depends="do-setup-sms"
	        description="Setup the build environment">
	  <!-- 1) Copy JADE sources -->
	  <copy todir="${src}">
			<fileset dir="${jade-src}">
				<include name="**/starlight/**"/>
				<include name="**/jade/**"/>
				
				<exclude name="**/jade/content/acl/**"/>
				<exclude name="**/jade/content/lang/j/**"/>
				<exclude name="**/jade/core/mobility/**"/>
				<exclude name="**/jade/core/event/**"/>
				<exclude name="**/jade/domain/introspection/**"/>
				<exclude name="**/jade/domain/mobility/**"/>
				<exclude name="**/jade/domain/DFGUIManagement/**"/>
				<exclude name="**/jade/imtp/**"/>
				<exclude name="**/jade/mtp/iiop/**"/>
				<exclude name="**/jade/mtp/http/**"/>
				<exclude name="**/jade/gui/**"/>
				<exclude name="**/jade/tools/**"/>
				<exclude name="**/jade/wrapper/**"/>
				<!-- The following files cannot include preprocessor directives. They must be excluded manually -->
				<exclude name="**/jade/lang/acl/ASCII_CharStream.java"/>
				<exclude name="**/jade/lang/acl/ACLParser.java"/>
				<exclude name="**/jade/lang/acl/ACLParserConstants.java"/>
				<exclude name="**/jade/lang/acl/ACLParserTokenManager.java"/>
				<exclude name="**/jade/lang/acl/ParseException.java"/>
				<exclude name="**/jade/lang/acl/Token.java"/>
				<exclude name="**/jade/lang/acl/TokenMgrError.java"/>
				<exclude name="**/jade/content/lang/sl/ASCII_CharStream.java"/>
				<exclude name="**/jade/content/lang/sl/SLParser.java"/>
				<exclude name="**/jade/content/lang/sl/SLParserConstants.java"/>
				<exclude name="**/jade/content/lang/sl/SLParserTokenManager.java"/>
				<exclude name="**/jade/content/lang/sl/ParseException.java"/>
				<exclude name="**/jade/content/lang/sl/Token.java"/>
				<exclude name="**/jade/content/lang/sl/TokenMgrError.java"/>
			</fileset>
		</copy>
	  <!-- 2) Copy LEAP sources -->
	  <copy todir="${src}" overwrite="yes">
			<fileset dir="${leap-src}">
			  <exclude name="**/jade/mtp/http/**"/>
				<exclude name="**/*.java@"/>
				<exclude name="**/*.java#"/>
				<exclude name="**/jade/imtp/leap/sms/*"/>
			</fileset>
		</copy>
	  <!-- 3) Preprocess the whole for MIDP -->
	  <pproc basedir="${src}" type="midp"/>
	  
	  <!-- 4) Preprocess the whole for CUSTOM directives -->
	  <pproc basedir="${src}" type="${additional-pproc-type}"/>
	</target>

	
	<!-- RESET -->
	<target name="do-reset" 
	        description="Reset the build environment">
		<delete dir = "${midp-root}"/>
	</target>

	
	<!-- CLEAN -->
	<target name="do-clean"
	        description="Clean class files">
		<delete dir = "${classes}"/>
		<delete dir = "${unverified}"/>
		<delete dir = "${doc}"/>
		<delete dir = "${lib}"/>
		<mkdir dir="${classes}"/>
		<mkdir dir="${unverified}"/>
		<mkdir dir="${lib}"/>
		<mkdir dir="${doc}"/>
	</target>


	<!-- COMPILE -->
	<target name="do-compile" depends="do-setup"
	        description="Compile sources">
    <echo>MIDP version: ${midp-version}</echo>
    <echo>Bootclasspath: ${boot-midp-classes}</echo>
		<javac srcdir="${src}"
		       destdir="${unverified}"
		       debug="${debug-build}"
		       optimize="${optimised-build}"
		       deprecation="on"
		       bootclasspath="${boot-midp-classes}"/>
		<preverify unverified="${unverified}" verified="${classes}"/>
	</target>

	
	<!-- LIB -->
	<target name="do-lib" depends="do-compile"
	        description="Create Jade-leap jar file">
		<delete file="${lib}/JadeLeap.jar" quiet="true"/>
        <condition property="manifest-file" 
                   value="resources/build/jade-leap.manifest">
          <equals arg1="${midp-version}" arg2="1.0" trim="true" />
        </condition>
        <condition property="manifest-file" 
                   value="resources/build/jade-leap-midp20.manifest">
          <equals arg1="${midp-version}" arg2="2.0" trim="true" />
        </condition>
		<jar jarfile="${lib}/JadeLeap.jar" basedir="${classes}" manifest="${manifest-file}"/>
        <!-- Update jad file -->          
        <updatejad jad="jade-leap.jad" />
	</target>

	
	<!-- JAVADOC -->
	<target name="do-javadoc" depends="do-setup"
	        description="Generate javadoc">
		<javadoc sourcepath="${src}"
		         destdir="${doc}"
		         classpath="${classes};${boot-midp-classes}"
		         doctitle="&lt;h1>${midp-title}&lt;/h1>"
		         bottom="${javadoc-footer}"
		         verbose="false"
		         windowtitle="${midp-title}"
		         packagenames="jade.*, starlight.* "/>
	</target>


	<!-- DEMO -->
	<target name="do-demo" depends="do-init, do-compile"
	        description="Build the demo">
		<delete dir = "${demo-preprocessed}" quiet="true"/>
		<delete dir = "${demo-unverified}" quiet="true"/>
		<delete dir = "${demo-classes}" quiet="true"/>
		<mkdir dir="${demo-preprocessed}"/>
		<mkdir dir="${demo-unverified}"/>
		<mkdir dir="${demo-classes}"/>
		
	  <copy todir="${demo-preprocessed}" overwrite="yes">
			<fileset dir="${demo-src}">
			</fileset>
		</copy>
		
	  <pproc basedir="${demo-preprocessed}" type="midp"/>
	  
		<javac srcdir="${demo-preprocessed}"
		       destdir="${demo-unverified}"
		       classpath="${classes}"
		       debug="${debug-build}"
		       optimize="${optimised-build}"
		       deprecation="off"
		       bootclasspath="${boot-midp-classes}"
		       target="1.1"/>
		       
		<preverify unverified="${demo-unverified}" verified="${demo-classes}" classpath="${classes}"/>		
	  
		<copy todir="${demo-classes}">
			<fileset dir="${classes}">
			</fileset>
		</copy>
		
		<delete file="${demo}/demoMidp.jar" quiet="true"/>
		<jar jarfile="${demo}/demoMidp.jar" basedir="${demo-classes}" manifest="${demo}/demo.manifest"/>

		<!-- Update jad file -->          
    <updatejad jad="${demo}/demo.jad" />
	</target>

</project>
